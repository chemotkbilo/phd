\documentclass{ltxdoc}
\usepackage{geometry}
\usepackage{phd}
\makeatletter
\newif\if@phdpreamble\@phdpreambletrue


\AtBeginDocument{\@phdpreamblefalse}
\makeatother
\usepackage{atbegshi}
\usepackage[pagelayout,savepos]{zref}
\sethyperref
%\luadirect{y='test'}

\input{defaultstyle}
\AtBeginShipout{%
 \setbox\AtBeginShipoutBox=\vbox{%
  \vbox to 0pt{%
%\mbox{ \directlua{
%z=\thepage
%  tex.print('This is a test', z, y)
%}}
}
 \vbox to 0pt{{%
 \kern-1.5in %
 \hbox to 0pt{{%
 \kern-1.5in %
 \color{blue}%
 \rule{1in}{1in}%
 \hss
 }}%
 \vss
 }}%
 \hrule
 \hbox{\vrule\box\AtBeginShipoutBox\vrule}%
 \hrule
 }%
 }
\usepackage{makeidx}
 \makeindex
\begin{document}

testing \index{test}
\indexcommand[\textbar]{|}

\theindex
\printindex
\end{document}


\cxset{chapter name=chapter}
\cxset{chapter lua/.store in=\somecode}
\cxset{chapter lua=\luacode{ 
          y = 'some string' .. z}}
\mainmatter
\chapter{Test}
\section{test}

\input{./sections/geometry-chapter}
\lipsum[1-3]


 
\lipsum[1-50]








\end{document}