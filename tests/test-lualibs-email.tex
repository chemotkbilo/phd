\documentclass{article}
\usepackage{luacode, filecontents}


\long\def\parta{%
\luadirect{
-- load the smtp support
local smtp = require("socket.smtp")
-- Connects to server "localhost" and sends a message to users
-- "fulano@example.com",  "beltrano@example.com", 
-- and "sicrano@example.com".
-- Note that "fulano" is the primary recipient, "beltrano" receives a
-- carbon copy and neither of them knows that "sicrano" received a blind
-- carbon copy of the message.
from = "<luasocket@example.com>"
rcpt = {
  "<y.lazarides@example.com>",
  "<beltrano@example.com>",
 }
}
 }
 
\long\def\partb{
\luadirect{
r, e = smtp.send{
  from = from,
  rcpt = rcpt, 
  source = smtp.message(mesgt)
  }
}}

\long\def\john#1{%
\luadirect{
  mesgt,headers = {}, {}
  
  mesgt.headers.body = #1
}}

\begin{document}

\john{Hi!}

\end{document}











