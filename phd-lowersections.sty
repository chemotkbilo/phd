%%
%% This is file `phd-lowersections.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% phd-lowersections.dtx  (with options: `LSECT')
%% ----------------------------------------------------------------
%% phd --- A package to beautify documents.
%% E-mail: yannislaz@gmail.com
%% Released under the LaTeX Project Public License v1.3c or later
%% See http://www.latex-project.org/lppl.txt
%% ----------------------------------------------------------------





\NeedsTeXFormat{LaTeX2e}[1994/12/01]%
\ProvidesFile{phd-lowersections}[2015/1/13 v1.0 less preamble (YL)]%
\let\ltxtoday\today
\newif\if@ltxcompat \@ltxcompatfalse
\newcommand\tikzi[1][after heading] {
   %\if@debug
    \tikz[remember picture,overlay]
    \draw[<->] (0,0)--(0,.2)--++(-.5,0) node[left,fill=blue!15,text=black]%
       {{\ttfamily\footnotesize #1}};%\space%
   %\fi
  }
\ExplSyntaxOn
\def\l_phd_subsection_number_prefix_tl {}
\def\l_phd_subsection_number_suffix_tl {}
\def\l_phd_subsubsection_number_prefix_tl{}
\def\l_phd_subsubsection_number_suffix_tl{}
\def\l_phd_paragraph_number_prefix_tl{}
\def\l_phd_paragraph_number_suffix_tl{}
\def\l_phd_subparagraph_number_prefix_tl{}
\def\l_phd_subparagraph_number_suffix_tl{}
\clist_new:N \phd_book_divisions_clist
\clist_gset:Nn \phd_book_divisions_clist
  {
    chapter,section,subsection,subsubsection,
    paragraph,subparagraph
  }

\dim_gzero_new:N \l_phd_section_title_border_left_width_dim

\cs_new:Npn \phd_create_new_element:nn #1 #2 #3
  {
    \dim_gzero_new:c {l_phd_#1#2_#3_top_width_dim} %margin
    \dim_gzero_new:c {l_phd_#1#2_#3_right_width_dim}
    \dim_gzero_new:c {l_phd_#1#2_#3_bottom_width_dim}
    \dim_gzero_new:c {l_phd_#1#2_#3_left_width_dim}
 }

\cs_new:Npn \phd_create_new_element_auxiliary:nn #1
  {
     \phd_create_new_element:nn {#1} {} {margin}
     \phd_create_new_element:nn {#1} {} {padding}
     \phd_create_new_element:nn {#1} {} {border}
     \phd_create_new_element:nn {#1} {title} {margin}
     \phd_create_new_element:nn {#1} {title} {padding}
     \phd_create_new_element:nn {#1} {title} {border}
  }

\clist_map_inline:Nn \phd_book_divisions_clist
  {
     \phd_create_new_element:nn {#1} {} {margin}
     \phd_create_new_element:nn {#1} {} {padding}
     \phd_create_new_element:nn {#1} {} {border}
     \phd_create_new_element:nn {#1} {_title} {margin}
     \phd_create_new_element:nn {#1} {_title} {padding}
     \phd_create_new_element:nn {#1} {_title} {border}
  }

\cs_new:Npn \printproperties
  {
    \input{debug-dims}
  }
\ExplSyntaxOff
\ExplSyntaxOn
\def\makekeys#1
 {
  \cxset
    {
     #1~name/.code                 = \cs_gset:cpn {#1name} {##1},
     #1~beforeskip/.code           = \cs_gset:cpn {l_phd_#1_before_skip_tl}{##1},
     #1~afterskip/.code            = \cs_gset:cpn {l_phd_#1_after_skip_tl}{##1},
     #1~indent/.code               = \cs_gset:cpn {l_phd_#1_indent_tl}{##1},
     #1~font-size/.fontsize        = l_phd_#1_fontsize_tl,
     #1~font-weight/.fontweight    = l_phd_#1_fontweight_tl,
     #1~font-shape/.fontstyle      = l_phd_#1_fontshape_tl,
     #1~font-family/.fontfamily    = l_phd_#1_fontfamily_tl,
     #1~format/.format~in          = l_phd_#1_format_tl,
     #1~background-color/.colorin  =  l_phd_#1_background_color_tl,
     #1~color/.colorin             =  l_phd_#1_color_tl,
     #1~shadow/.code               = \cs_gset:cpn {l_phd_#1_shadow_tl}{drop~shadow},
     #1~align/.textalign           = l_phd_#1_align_tl,
     #1~arc/.code                  = \cs_gset:cpn {l_phd_#1_arc_tl} {##1},
     #1~grow~left/.code            = \cs_gset:cpn {l_phd_#1_grow_left_dim}{##1},
     #1~grow~right/.code           = \cs_gset:cpn {l_phd_#1_grow_right_dim}{##1},
     #1~rounded~corners/.code      = \cs_gset:cpn {l_phd_#1_rounded_corners_tl}{##1},
     #1~afterindent/.onoff         = {afterindent@cx},
     #1~border-top-width/.code     = \dim_set:cn {l_phd_#1_border_top_width_dim}    {##1},
     #1~border-right-width/.code   = \dim_set:cn {l_phd_#1_border_right_width_dim}  {##1},
     #1~border-bottom-width/.code  = \dim_set:cn {l_phd_#1_border_bottom_width_dim} {##1},
     #1~border-left-width/.code    = \dim_set:cn {l_phd_#1_border_left_width_dim}   {##1},
     #1~padding-top-width/.code    = \dim_set:cn {l_phd_#1_padding_top_width_dim}    {##1},
     #1~padding-right-width/.code  = \dim_set:cn {l_phd_#1_padding_right_width_dim}  {##1},
     #1~padding-bottom-width/.code = \dim_set:cn {l_phd_#1_padding_bottom_width_dim} {##1},
     #1~padding-left-width/.code   = \dim_set:cn {l_phd_#1_padding_left_width_dim}   {##1},
     #1~margin-top-width/.code     = \dim_set:cn {l_phd_#1_margin_top_width_dim}    {##1},
     #1~margin-right-width/.code   = \dim_set:cn {l_phd_#1_margin_right_width_dim}  {##1},
     #1~margin-bottom-width/.code  = \dim_set:cn {l_phd_#1_margin_bottom_width_dim} {##1},
     #1~margin-left-width/.code    = \dim_set:cn {l_phd_#1_margin_left_width_dim}   {##1},
}
}
\def\makenumberingkeys #1 {
\cxset{
     #1~number~prefix/.code        = \cs_gset:cpn {l_phd_#1_number_prefix_tl} {##1},
     #1~number~suffix/.code        = \cs_gset:cpn {l_phd_#1_number_suffix_tl} {##1},

     #1~number~after/.code         = \cs_gset:cpn {l_phd_#1_number_after_tl},
     #1~numbering/.is~choice,
     #1~numbering/roman/.code          =
       \cs_gset:cpn {the#1}
         {
           \cs:w l_phd_#1_number_prefix_tl \cs_end:
             \@roman\cs:w c@#1\cs_end:\relax
           \cs:w l_phd_#1_number_suffix_tl \cs_end:
         },
     #1~numbering/Roman/.code          =
      \cs_gset:cpn {the#1}
        {
          \cs:w l_phd_#1_number_prefix_tl \cs_end:
          \expandafter\@Roman{\cs:w c@#1\cs_end:\relax}
          \cs:w l_phd_#1_number_suffix_tl \cs_end:
        },
    #1~numbering/(roman)/.code          =
    \cs_gset:cpn {the#1}
       {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
         (\@roman\cs:w c@#1\cs_end:\relax)
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
       },
    #1~numbering/(Roman)/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        (\@Roman \cs:w c@#1\cs_end:\relax)
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/arabic/.code           =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \@arabic\cs:w c@#1\cs_end: \relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/numeric/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \@arabic\cs:w c@#1\cs_end:\relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/none/.code             =
    \cs_gset:cpn {the#1} {},
   #1~numbering/alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \exp_after:wN \alphalph {\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/Alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
          \exp_after:wN \AlphAlph{\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/words/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
       \words@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/Words/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \Words@cx{\@arabic\cs:w c@#1\cs_end:\relax }
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/WORDS/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
       \WORDS@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering~custom/.code           =
    \cs_gset:cpn {the#1} {##1},
  }
 }

\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \makekeys{#1}
  }

\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \makenumberingkeys{#1}
  }

\ExplSyntaxOff
\ExplSyntaxOn
\gdef\makeotherelements #1 #2 {
  \cxset{
  %
     #1~#2~width/.code          =
        \expandafter\def\cs:w l_phd_#1_#2_width_dim\cs_end:{##1},
     #1~#2~margin-top/.code       = \dim_gset:cn {l_phd_#1_#2_margin_top_width_dim} {##1}\relax,
     #1~#2~margin-right/.code     = \dim_gset:cn {l_phd_#1_#2_margin_right_width_dim} {##1}\relax,
     #1~#2~margin-bottom/.code    = \dim_gset:cn {l_phd_#1_#2_margin_bottom_width_dim} {##1}\relax,
     #1~#2~margin-left/.code      = \dim_gset:cn {l_phd_#1_#2_margin_left_width_dim} {##1}\relax,
     #1~#2~align/.textalign           = l_phd_#1_#2_align_tl,
     #1~#2~font-size/.fontsize        = l_phd_#1_#2_fontsize_tl,
     #1~#2~font-weight/.fontweight    = l_phd_#1_#2_fontweight_tl,
     #1~#2~font-shape/.fontstyle      = l_phd_#1_#2_fontshape_tl,
     #1~#2~font-family/.fontfamily    = l_phd_#1_#2_fontfamily_tl,
     #1~#2~color/.code                = \cs_gset:cpn {l_phd_#1_#2_color_tl} {\color{##1}},
   }
 }
\def\makeotherelementsaux #1
{
     \makeotherelements {#1}{title}
     \makeotherelements {#1}{label}   % chapter_label is Chapter
     \makeotherelements {#1}{number}  % chapter_number refers to the number
     \makeotherelements {#1}{before}
     \makeotherelements {#1}{after}
}

\clist_map_inline:Nn \phd_book_divisions_clist
{
  \makeotherelementsaux {#1}
}

\ExplSyntaxOff
\cxset
  {
    chapter title margin-top       = 0cm,
    chapter title margin-right     = 1cm,
    chapter align                  = Centering,
    chapter title align            = Centering, %checked
    chapter name                   = Section,
    chapter format                 = block,
    chapter font-size              = HUGE,
    chapter font-weight            = bold,
    chapter font-family            = sffamily,
    chapter font-shape             = upshape,
    chapter color                  = spot!30,
    chapter number prefix          = ,
    chapter number suffix          = ,
    chapter numbering              = arabic,
    chapter indent                 = 0pt,
    chapter beforeskip             = 10pt,
    chapter afterskip              = -3ex,
    chapter afterindent            = off,
    chapter number after           = \quad,
    chapter arc                    = 3pt,
    chapter background-color       = spot!30,
    chapter afterindent            = off,
    chapter grow left              = 0mm,
    chapter grow right             = 0mm,
    chapter rounded corners        = northeast,
    chapter shadow                 = drop shadow,
    chapter border-left-width      = 0pt,
    chapter border-right-width     = 0pt,
    chapter border-top-width       = 2pt,
    chapter border-bottom-width    = 2pt,
    chapter padding-left-width     = 0pt,
    chapter padding-right-width    = 10pt,
    chapter padding-top-width      = 10pt,
    chapter padding-bottom-width   = 10pt,
    %
    chapter number font-size        = Huge,
    chapter number font-weight      = bfseries,
    chapter number font-family      = sffamily,
    chapter number font-shape       = upshape,
    chapter number color            = spot!30,
    chapter title font-size        = Huge,
    chapter title font-weight      = bold,
    chapter title font-family      = sffamily,
    chapter title font-shape       = upshape,
    chapter title color            = spot!30,
}
\ExplSyntaxOn

\cxset
  {
    section~spaceout/.is~choice,
    section~spaceout/soul/.code            = \@sectionspaceouttrue,
    section~spaceout/none/.code            = \@sectionspaceoutfalse,
 }

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \format_inmargin:nnn #1#2#3
  {
     \tcbdocmarginnote
     {

       \hbox{Section~\@svsec}
       #3
     }
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_hang:nn #1#2#3
  {{ \@hangfrom{#2\relax\@svsec%
      \interlinepenalty \@M #3\@@par}%
  }}
\ExplSyntaxOff

\ExplSyntaxOn
\cs_gset:Npn \phd_set_box_parameters:nn #1 #2
{
  % background color
    \cs_if_exist:cTF {l_phd_#1_background_color_tl}
      {
        \cs_set:cpn {#1tcbbgcolor} { \cs:w l_phd_#1_background_color_tl\cs_end: }
      }
      {
        \cs_set:cpn {#1tcbbgcolor} {white}
      }
   \cs_if_exist:cTF {l_phd_#1_arc_tl}
     {
       \cs_set:cpn {tcbarc_#2}
              {\cs:w l_phd_#1_arc_tl \cs_end: }
     }
     {
        \cs_set:cpn {tcbarc_#2} {0pt}
     }
\cs_if_exist:cTF {l_phd_#1_grow_left_dim}
    {
      \def\tcbgrowleft{\csname l_phd_#1_grow_left_dim \endcsname}
    }
    {
      \def\tcbgrowleft{0pt}
    }
\cs_if_exist:cTF {l_phd_#1_grow_right_dim}
    {
      \def\tcbgrowright{\cs:w l_phd_#1_grow_right_dim \cs_end:}
    }
    {
      \def\tcbgrowright{0pt}
    }

\cs_if_exist:cTF {l_ phd_#1_shadow_tl}
    {
      \gdef\tcbshadow
       {
        \cs:w l_phd_#1_shadow_tl \cs_end:
       }
    }
    {
      \gdef\tcbshadow{no~shadow}
    }

\cs_if_exist:cTF {l_phd_#1_rounded_corners_tl}
    {
      \def\tcbroundedcorners{\cs:w l_phd_#1_rounded_corners_tl \cs_end:}
    }
    {
      \def\tcbroundedcorners{all}
    }
 % dimensional constants
  \dim_if_exist:cTF { l_phd_#1_title_margin_top_width_dim }
    {
      \gdef\tcbtitlevspace{\dim_use:c { l_phd_#1_title_margin_top_width_dim} }
    }
    {
      \gdef\tcbtitlevspace{0pt}
    }
  \dim_if_exist:cTF {l_phd_#1_border_top_width_dim }
    {
      \def\tcbtoprulewidth{\dim_use:c {l_phd_#1_border_top_width_dim} }
    }
    {
      \def\tcbtoprulewidth{0pt}
    }
 \dim_if_exist:cTF {l_phd_#1_border_left_width_dim }
    {
      \def\tcbleftrulewidth{\dim_use:c {l_phd_#1_border_left_width_dim} }
    }
    {
      \def\tcbleftrulewidth{0pt}
    }

 \dim_if_exist:cTF {l_phd_#1_border_bottom_width_dim }
    {
      \def\tcbbottomrulewidth{\dim_use:c {l_phd_#1_border_bottom_width_dim} }
    }
    {
      \def\tcbbottomrulewidth{0pt}
    }
 \dim_if_exist:cTF {l_phd_#1_border_right_width_dim }
    {
      \def\tcbrightrulewidth {\dim_use:c {l_phd_#1_border_right_width_dim} }
    }
    {
      \def\tcbrightrulewidth{0pt}
    }

\dim_if_exist:cTF {l_phd_#1_padding_top_width_dim }
    {
      \cs_set:cpn {#1tcbtopsepwidth} {\dim_use:c {l_phd_#1_padding_top_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbtopsepwidth} {0pt}
    }
 \dim_if_exist:cTF {l_phd_#1_padding_left_width_dim }
    {
      \cs_set:cpn {#1tcbleftsepwidth} {\dim_use:c {l_phd_#1_padding_left_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbleftsepwidth} {0pt}
    }

 \dim_if_exist:cTF {l_phd_#1_padding_bottom_width_dim }
    {
      \cs_set:cpn {#1tcbbottomsepwidth} {\dim_use:c {l_phd_#1_padding_bottom_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbbottomsepwidth} {0pt}
    }
 \dim_if_exist:cTF {l_phd_#1_padding_right_width_dim }
    {
      \cs_set:cpn {#1tcbrightsepwidth} {\dim_use:c {l_phd_#1_padding_right_width_dim} }
    }
    {
      \cs_set:cpn {#1tcbrightsepwidth} {0pt}
    }

}
\cs_set:Npn \make_box_style:n #1 #2
  {
    \phd_set_box_parameters:nn {#1}{#2} %section outer
    \tcbset
      {
        #1~#2/.style=
          {
            size               = minimal, %resets
            enhanced,
            colback            = white, %fix\cs:w #1tcbbgcolor \cs_end:,
            colframe           = black!80,
            sharpish~corners,
            sharp~corners      = all,
            %arc                = 6mm,%\tcbarc_outer,
            auto~outer~arc,
            rounded~corners    = east,%\tcbroundedcorners,
            %\tcbshadow,
            fuzzy~shadow       = {2mm}{-1mm}{0mm}{0.1mm}{black!50!white},
            right              = 10mm,%\cs:w #1tcbrightsepwidth  \cs_end:,
            bottom             = 3mm,%\cs:w #1tcbbottomsepwidth \cs_end:,
            top                = 3mm,%\cs:w #1tcbtopsepwidth    \cs_end:,
       }
    }
  }
\tcbset{
  chapter/.style = {
      }
  }
\tcbset{
  _title/.style = {
      }
  }
\tcbset{
  _number/.style = {
      }
  }

 \tcbset{section/.style={chapter}}
 \tcbset{subsection/.style={chapter}}
 \tcbset{subsubsection/.style={chapter}}
\bool_new:N \combo_if_bool \bool_gset_true:N \combo_if_bool

\cs_set:Npn \format_block:nnnn #1#2#3#4
{
 \bgroup
 \make_box_style:n {#1} {outer}
 \make_box_style:n {#1} {inner}
 \leftskip-1cm
 \begin{tcolorbox}[
                   #1~outer,
                   width=\linewidth+2cm,
                   arc=3mm,
                   %drop~shadow=black,
                   %rounded~corners=all,
                   colback=spot!15
                  ]
\bool_if:NTF \combo_if_bool
  {
    \phd_float_box:nnn {#1}{_number}
        {
          \tcbox[size=minimal,
                 nobeforeafter,
                 colback=spot!15,
           fontlower={
             \l_phd_chapter_number_fontweight_tl
             \l_phd_chapter_number_fontfamily_tl
             \l_phd_chapter_number_fontshape_tl
             \l_phd_chapter_number_fontsize_tl
              },
          ]
          {
            \cs:w #1name\cs_end:\space
            \cs:w the#1\cs_end:
           }
        }
   }
   {
     \phd_float_box:nnn {#1}{}
       {
         \tcbox{\@svsec}

       }
   }
    \dim_compare:nNnTF {\tcbtitlevspace} > {0sp}
    {
      \skip_vertical:N \tcbtitlevspace
    }
    {}
   \phd_float_box:nnn {#1}{}{}
   \phd_float_box:nnn {#1}{_title}{#4}
   \par
   \end{tcolorbox}
 \egroup
 \par\nobreak\nointerlineskip
}
\cs_set:Npn \phd_float_box:nnn #1 #2 #3
{
  \begin{tcolorbox}
    [#1~outer,
      size=minimal,no~shadow,colback=spot!15,
      #1
    ]
    \cs:w l_phd_#1#2_align_tl \cs_end:
    \begin{tcolorbox}
      [
        #1~outer,#2,
        size=minimal, no~shadow,colback=spot!15,
        %drop~shadow,
        width=0.7\textwidth,
       ]
          \language-1\relax
      \cs:w  l_phd_#1#2_fontweight_tl  \cs_end:
      \cs:w  l_phd_#1#2_fontfamily_tl  \cs_end:
      \cs:w  l_phd_#1#2_fontsize_tl    \cs_end:
      \cs:w  l_phd_#1#2_fontshape_tl   \cs_end:
     % \cs:w  l_phd_#1#2_color_tl       \cs_end:
      \cs:w  l_phd_#1#2_align_tl       \cs_end:
      #3
      \par
  \end{tcolorbox}
   \par
  \end{tcolorbox}
}

\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_display:nnnn #1 #2 #3 #4
{
  \cxset{#1~title~margin-top=30pt}
  \format_block:nnnn {#1}{#2}{#3}{#4}
}
 \ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_inline:nnn #1 #2 #3
  {
   {\bfseries\normalfont
    \theparagraph #3}
   }
\ExplSyntaxOff
\ExplSyntaxOn
\DeclareDocumentCommand \start_section:nnnnnnnnn {m m m m m m s o m}
  {
    \if@noskipsec \leavevmode \fi
    \par
    \l_tmpa_skip #4\relax
    \@afterindenttrue
    \if_dim:w \l_tmpa_skip <\z@
      \skip_gset:Nn\l_tmpa_skip {-\l_tmpa_skip}
      \@afterindentfalse
    \fi:
    \if@nobreak
      \everypar{\tikzi[start\\sect]}
    \else
      \addpenalty \@secpenalty
      \addvspace\l_tmpa_skip
    \fi
    \IfBooleanTF {#7}
      {\@ssect {#3} {#4} {#5} {#6} {#9} }
      {
        \IfValueTF {#8} {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} }
                        {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} } %sends TF we get it later
      }
  }
\@ltxcompattrue
\if@ltxcompat
  \else
  \cs_gset_eq:NN \@startsection \start_section:nnnnnnnnn
\fi

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \@sect: #1 #2 #3 #4 #5 #6 [#7] #8
  {

    \int_compare:nTF {#2>\c@secnumdepth}
      {
         \let\@svsec\@empty
      }
      {
        \refstepcounter{#1}
        \protected@edef\@svsec
          {
            \@seccntformat{#1}\relax
          }
        % add short title or long title
        \IfValueTF{#7}
          {
             \cs:w #1mark\cs_end: {#7}
             \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}#7}
          }
          {
             \cs:w #1mark\cs_end: {#8}
              \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}#8}
          }
      }

   \@tempskipa #5\relax
   \gdef\@svsechd{
   %\@seccntformat{#1}#6{\hskip #3\relax #8}
   #8
   }%

    \str_case_x:nnTF {\cs:w l_phd_#1_format_tl \cs_end:}
      {
          { display } {\format_display:nnnn { #1 } { #3 } {#6} { #8 }
                        \xsect:n {#5}   }
          { block   } { \format_block:nnnn  {#1 } { #3 } {#6} { {#8}       }
                        \xsect:n {#5}
                      }
          { plain   } { \format_hang:nn    {#1} { #3 } { #8 }         }
          { hangs    } { \format_hang:nn    { #1 } { #3 } {{#6#8}} \xsect:n {#5}   }
          { inline   } {  \xsect:n {-3.5ex} }%#5
          { inmargin } {\format_inmargin:nnn {#1} {#3} {#6#8} }
      }
      {
      %{\if@debug~\tiny\csname#1format@cx\endcsname \fi }
      } %true code
      {
        {
        %\if@debug~\tiny\csname#1format@cx\endcsname\fi
        }
        \@hangfrom{#6\relax\@svsec}%
        \interlinepenalty\@M {#6#8}\par\xsect:n{#5}
      } %false code
  %
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \@ssect #1 #2 #3 #4 #5 {%
  \@tempskipa #3\relax
  \ifdim \@tempskipa>\z@
  \begingroup
    #4{
    \@hangfrom{\hskip #1}%
    \interlinepenalty \@M (#5)\@@par}%
    \endgroup
  \else
  \def\@svsechd{#4{\hskip #1\relax #5}}%
  \fi
  \xsect:n{#3} ONLY NEEDED FOR HANG PARA
}
\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \xsect:n #1
  {
  \l_tmpa_skip #1\relax
  \if_dim:w \l_tmpa_skip>0pt %WATCH better boolean
    \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading
   \else:
    \@nobreakfalse
    \global\@noskipsectrue
    \tex_everypar:D
      {\if@noskipsec
          \global\@noskipsecfalse%resets switch
          {\setbox\z@\lastbox}
          \tex_clubpenalty:D\@M
          \group_begin:
            \parindent0pt\tcbox[size=minimal,
                    nobeforeafter,
                    box~align=base]{\bfseries \@svsechd }%}
          \group_end:
          \tex_unskip:D
          \l_tmpa_skip #1\relax
          \hskip -\l_tmpa_skip
        \else
          \tex_clubpenalty:D \@clubpenalty
          \tex_everypar:D {\tikzi[every]}
        \fi
      }
  \fi:
  \tex_ignorespaces:D
  }

\cs_set:Npn \after_block:n #1
 {
   \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading
 }

\ExplSyntaxOff
 \def\@afterheading{%
 \@nobreaktrue
 \everypar{%
   \if@nobreak
     \@nobreakfalse
     \clubpenalty \@M
     \if@afterindent
     \else
      {\setbox\z@\lastbox}%
     %\tikzi[everypar]
     \fi
 \else
 \clubpenalty \@clubpenalty
 \everypar{
   %\tikzi[cleared]
 }%
 \fi}
 }
\ExplSyntaxOn
 \cs_gset:Npn \@seccntformat #1
 {
  \@ifundefined{#1@cntformat}%
  {\csname the#1\endcsname\section_number_after_tl}% default
  {\csname #1_cntformat\endcsname}% individual control
 }
\tl_set:Nn  \section_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsubsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \l_phd_paragraph_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subparagraph_number_after_tl{\quad}%default value only space
\cs_set:Npn \section_cntformat{\thesection\section_number_after_tl}
\cs_set:Npn \subsection_cntformat{\thesubsection\subsection_number_after_tl}
\cs_set:Npn \subsubsection_cntformat{\thesubsubsection\subsubsection_number_after_tl}
\cs_set:Npn \paragraph_cntformat {\theparagraph\l_phd_paragraph_number_after_tl }
\cs_set:Npn \subparagraph_cntformat {\thesubparagraph\subparagraph_number_after_tl }
\ExplSyntaxOff
\ExplSyntaxOn

 \renewcommand\chapter {%
   \newpage\null
    \start_section:nnnnnnnnn{chapter}%
      {0}  %level check this conflicts with source2e

      {\l_phd_chapter_indent_tl} %indent#2

      {\l_phd_chapter_before_skip_tl}%before skip#3

      {\l_phd_chapter_after_skip_tl}% after skip#4

      {
          %\expandafter\setfontparam@cx\l_phd_chapter_align_tl;%
          %\color{\l_phd_chapter_color_tl}%5
      }
 }%


\ExplSyntaxOff
\ExplSyntaxOn
\ExplSyntaxOff
\ExplSyntaxOn
%%    {\l_phd_subsubsection_fontweight_tl }
%%    {\l_phd_subsubsection_fontfamily_tl}
%%    {\l_phd_subsubsection_fontsize_tl}
%%    {\l_phd_subsubsection_fontshape_tl}
%%      \expandafter\setfontparam@cx
\ExplSyntaxOff

\ExplSyntaxOn
%%     \setfont@cx
%%      {\l_phd_paragraph_fontweight_tl}%
%%     {\l_phd_paragraph_fontfamily_tl}
%%     {\l_phd_paragraph_fontsize_tl}
%%     {\l_phd_paragraph_fontshape_tl}%
%%     \expandafter\setfontparam@cx\l_phd_paragraph_align_tl;%
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{0pt}%
                                       {2ex}%
                                       {-1em}%
                                      {\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph
      {
         \@startsection{subparagraph}
         {5}%level
         {\l_phd_subparagraph_indent_tl}%indent
         {\l_phd_subparagraph_before_skip_tl}
         {\l_phd_subparagraph_after_skip_tl}
         {
           \setfont@cx
           {\l_phd_subparagraph_fontweight_tl}
           {\l_phd_subparagraph_fontfamily_tl}
           {\l_phd_subparagraph_fontsize_tl}
           {\l_phd_subparagraph_fontshape_tl}%
           \expandafter\setfontparam@cx
             \l_phd_subparagraph_align_tl;
           \color{\l_phd_subparagraph_color_tl}
         }
       }

\fi
\ExplSyntaxOff

\cxset { section name              = Section,
    section format                 = block,
    section align                  = Centering,
    section title align            = Centering, %checked
    section font-size              = Large,
    section font-weight            = bfseries,
    section font-family            = serif,
    section font-shape             = upshape,
    section number font-size       = Large,
    section number font-weight     = bfseries,
    section number font-family     = serif,
    section number font-shape      = upshape,
    section title font-size        = Large,
    section title font-weight      = bfseries,
    section title font-family      = serif,
    section title font-shape       = upshape,
    section color                  = spot,
    section number prefix          = \thechapter.,
    section number suffix          =,
    section numbering              = arabic,
    section indent                 = 0pt,
    section beforeskip             = -3ex,
    section afterskip              = 10pt,
    section afterindent            = off,
    section number after           = \quad,
    section arc                    = 3pt,
    section background-color       = white,
    section afterindent            = off,
    section grow left              = 0mm,
    section grow right             = 0mm,
    section rounded corners        = northeast,
    section border-left-width      = 0pt,
    section border-right-width     = 0pt,
    section border-top-width       = 2pt,
    section border-bottom-width    = 2pt,
    section padding-left-width     = 0pt,
    section padding-right-width    = 10pt,
    section padding-top-width      = 2pt,
    section padding-bottom-width   = 2pt,
    section title margin-top       = 2pt,
    section title color            = spot,
    section shadow                 = no shadow,
  }
\cxset
  {
    subsection name                   = Subsection,
    subsection format                 = block,
    subsection font-size              = large,
    subsection font-weight            = bfseries,
    subsection font-family            = rmfamily,
    subsection font-shape             = upshape,
    subsection number font-size       = large,
    subsection number font-weight     = bfseries,
    subsection number font-family     = rmfamily,
    subsection number font-shape      = upshape,
    subsection title font-size        = Large,
    subsection title font-weight      = bfseries,
    subsection title font-family      = serif,
    subsection title font-shape       = upshape,
    subsection title color            = spot,
    subsection color                  = spot,
    subsection numbering              = arabic,
    subsection align                  = Centering, %checked
    subsection title align            = Centering, %checked
    subsection beforeskip             = -3.25ex\@plus -1ex \@minus -.2ex,
    subsection afterskip              = 1.5ex \@plus .2ex,
    subsection number prefix          = \thesection.,
    subsection indent                 = 0pt,
    subsection number after           = 0pt,
    subsection background-color       = white,
    subsection border-left-width      = 0pt,
    subsection border-right-width     = 0pt,
    subsection border-top-width       = 5pt,
    subsection border-bottom-width    = 5pt,
    subsection padding-left-width     = 0pt,
    subsection padding-right-width    = 0pt,
    subsection padding-top-width      = 20pt,
    subsection padding-bottom-width   = 20pt,
    subsection shadow                 = drop shadow,
  }
\cxset
  {
    subsubsection name                    = Subsubsection,
    subsubsection format                  = block,
    subsubsection background-color        = white!30, %checked
    subsubsection font-family             = rmfamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection font-family             = rmfamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection color                   = spot,
    subsubsection number prefix           = \thesubsection,
    subsubsection number suffix           = ,
    subsubsection numbering               = arabic,
    subsubsection indent                  = 0pt,
    subsubsection beforeskip              = -3.25ex\@plus -1ex \@minus -.2ex,
    subsubsection afterskip               = 1.5ex \@plus .2ex,
    subsubsection align                   = center,
    subsubsection title align             = center,
    subsubsection number after     =,
    subsubsection border-left-width       = 0pt,
    subsubsection border-right-width      = 0pt,
    subsubsection border-top-width        = 2pt,
    subsubsection border-bottom-width     = 0pt,
    subsubsection padding-left-width      = 0pt,
    subsubsection padding-right-width     = 0pt,
    subsubsection padding-top-width       = 20pt,
    subsubsection padding-bottom-width    = 20pt,
    subsubsection shadow                  = no shadow,
    subsubsection title font-size         = large,
    subsubsection title font-weight       = bfseries,
    subsubsection title font-family       = serif,
    subsubsection title font-shape        = upshape,
    subsubsection title color             = spot,
  }
\cxset
  {
    paragraph name                = paragraph,
    paragraph format              = inline,
    paragraph name                = paragraph,
    paragraph font-size           = large,
    paragraph font-weight         = bfseries,
    paragraph font-family         = rmfamily,
    paragraph font-shape          = upshape,
    paragraph numbering           = alpha,
    paragraph align               = flushleft,
    paragraph beforeskip          = 3.25ex plus1ex minus.2ex,
    paragraph afterskip           = -1em,
    paragraph indent              = 0pt,
    paragraph number after        = \quad,
    paragraph color               = spot,
    paragraph background-color    = white,
    paragraph shadow              = no shadow,
  }
\cxset
  {
    subparagraph name             = subparagraph,
    subparagraph format           = inline,
    subparagraph name             = subparagraph,
    subparagraph font-size        = large,
    subparagraph font-weight      = bfseries,
    subparagraph font-family      = rmfamily,
    subparagraph font-shape       = upshape,
    subparagraph color            = spot!30,
    subparagraph background-color = sweet!50
    subparagraph numbering        = none,
    subparagraph align            = flushleft,
    subparagraph beforeskip       = 3.25ex plus1ex minus .2ex,
    subparagraph afterskip        = -1em,
    subparagraph indent           = 0pt,
    subparagraph number after     = ,
    subparagraph shadow           = off,
  }
\cxset{chapter title style/.style= {
       chapter title align = Centering,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
 \cxset{subsection title style/.style= {
       subsection title align = Centering,}
 }
 \cxset{subsubsection title style/.style=
   {
        subsubsection align       = #1,
        subsubsection title align = #1,
   }
 }
 \cxset{subsubsection title style= raggedright}
\ExplSyntaxOn
\cs_set:Npn \testsections
  {
    \section{Sections}
    \lorem\par
    \subsection{Subsections}
    \lorem\par
    \subsubsection{Subsubsections}
    \lorem\par
    \paragraph {Paragraph}
  }
\cs_set_eq:NN \TestSections\testsections
\ExplSyntaxOff

\endinput
%%
%% End of file `phd-lowersections.sty'.
