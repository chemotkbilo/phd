%%
%% This is file `phd-lowersections.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% phd-lowersections.dtx  (with options: `LSECT')
%% ----------------------------------------------------------------
%% phd --- A package to beautify documents.
%% E-mail: yannislaz@gmail.com
%% Released under the LaTeX Project Public License v1.3c or later
%% See http://www.latex-project.org/lppl.txt
%% ----------------------------------------------------------------



\NeedsTeXFormat{LaTeX2e}[1994/12/01]%
\ProvidesFile{phd-lowersections}[2015/1/13 v1.0 less preamble (YL)]%
\ExplSyntaxOn
\let\ltxtoday\today
\let\phd_hang_from:nn \@hangfrom
\newif\if@ltxcompat \@ltxcompatfalse


\cs_if_exist:cTF {tikzi}
  {}
  {
    \newcommand\tikzi[1][after heading]
    {
   %\if@debug
    \tikz[remember~picture,overlay]
    \draw[<->] (0,0)--(0,.2)--++(-.5,0) node[left,fill=blue!15,text=black]%
       {{\ttfamily\footnotesize #1}};%\space%
   %\fi
    }
  }
\ExplSyntaxOff
\ExplSyntaxOn
\def\l_phd_subsection_number_prefix_tl {}
\def\l_phd_subsection_number_suffix_tl {}
\def\l_phd_subsubsection_number_prefix_tl{}
\def\l_phd_subsubsection_number_suffix_tl{}
\def\l_phd_paragraph_number_prefix_tl{}
\def\l_phd_paragraph_number_suffix_tl{}
\def\l_phd_subparagraph_number_prefix_tl{}
\def\l_phd_subparagraph_number_suffix_tl{}
\clist_new:N   \phd_book_divisions_clist
\clist_gset:Nn \phd_book_divisions_clist
  {
    part,chapter,section,subsection,subsubsection,
    paragraph,subparagraph
  }
\cs_new:Npn \phd_create_new_element:nn #1
  {
    \dim_gzero_new:c {l_phd_#1_margin_top_width_dim} %margin
    \dim_gzero_new:c {l_phd_#1_margin_right_width_dim}
    \dim_gzero_new:c {l_phd_#1_margin_bottom_width_dim}
    \dim_gzero_new:c {l_phd_#1_margin_left_width_dim}

    \dim_gzero_new:c {l_phd_#1_padding_top_width_dim} %margin
    \dim_gzero_new:c {l_phd_#1_padding_right_width_dim}
    \dim_gzero_new:c {l_phd_#1_padding_bottom_width_dim}
    \dim_gzero_new:c {l_phd_#1_padding_left_width_dim}

    \dim_gzero_new:c {l_phd_#1_border_top_width_dim} %margin
    \dim_gzero_new:c {l_phd_#1_border_right_width_dim}
    \dim_gzero_new:c {l_phd_#1_border_bottom_width_dim}
    \dim_gzero_new:c {l_phd_#1_border_left_width_dim}
 }
\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \phd_create_new_element:nn {#1}
  }

 \clist_new:N \phd_secondary
 \clist_gset:Nn \phd_secondary
 {
   part_label,
   part_label_before,
   part_number,
   part_title,
   part_title_before
   part_number_before,

   chapter_title,
   section_title,
   subsection_title,
   subsubsection_title,
   paragraph_title,
   subparagraph_title,
   chapter_title_before,
   chapter_label,
   section_label,
   subsection_label,
   subsubsection_label,
   paragraph_label,
   subparagraph_label,
   chapter_label_before,
   chapter_number,section_number,
   subsection_number,subsubsection_number,
   paragraph_number,subparagraph_number,

   chapter_number_before,

 }

\clist_map_inline:Nn \phd_secondary
  {
    \phd_create_new_element:nn {#1}
  }

\cs_new:Npn \printproperties
  {
    \input{debug-dims}
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \l_phd_make_new_heading_keys:n #1 #2
 {
  \cxset
    {
     #1~name/.store                = #1name,
     #1~afterindent/.onoff         = afterindent@cx,
     #1~align/.textalign           = l_phd_#2_align_tl,
     #1~beforeskip/.store          = l_phd_#2_before_skip_tl,
     #1~afterskip/.store           = l_phd_#2_afterskip_tl,
     #1~indent/.store              = l_phd_#2_indent_tl,
     #1~font-size/.fontsize        = l_phd_#2_fontsize_tl,
     #1~font-weight/.fontweight    = l_phd_#2_fontweight_tl,
     #1~font-shape/.fontstyle      = l_phd_#2_fontshape_tl,
     #1~font-family/.fontfamily    = l_phd_#2_fontfamily_tl,
     #1~case/.case                 = l_phd_#2_case_tl,
     #1~format/.format~in          = l_phd_#2_format_tl,
     #1~background-color/.store    = l_phd_#2_background_color_tl,
     #1~frame-color/.store         = l_phd_#2_frame_color_tl,
     #1~color/.colorin             = l_phd_#2_color_tl,
     #1~shadow/.shadow             = l_phd_#2_shadow_tl,

     #1~width/.store               = l_phd_#2_width,
     #1~arc/.store                 = l_phd_#2_arc_tl,
     #1~grow~left/.store           = l_phd_#2_grow_left_dim,
     #1~grow~right/.store          = l_phd_#2_grow_right_dim,
     #1~rounded~corners/.store     = l_phd_#2_rounded_corners_tl,
     #1~borderline~top/.store      = l_phd_#2_borderline_top_tl,
     #1~borderline~right/.store    = l_phd_#2_borderline_right_tl,
     #1~borderline~bottom/.store   = l_phd_#2_borderline_bottom_tl,
     #1~borderline~left/.store     = l_phd_#2_borderline_left_tl,
     #1~borderline~top-color/.store      = l_phd_#2_borderline_top_color_tl,
     #1~borderline~right-color/.store    = l_phd_#2_borderline_right_color_tl,
     #1~borderline~bottom-color/.store   = l_phd_#2_borderline_bottom_color_tl,
     #1~borderline~left-color/.store     = l_phd_#2_borderline_left_color_tl,
     #1~border-top-width/.store     =  {l_phd_#2_border_top_width_dim}    ,
     #1~border-right-width/.store   =  {l_phd_#2_border_right_width_dim}  ,
     #1~border-bottom-width/.store  =  {l_phd_#2_border_bottom_width_dim} ,
     #1~border-left-width/.store    =  {l_phd_#2_border_left_width_dim}   ,
     #1~padding-top-width/.store    =  {l_phd_#2_padding_top_width_dim}    ,
     #1~padding-right-width/.store  =  {l_phd_#2_padding_right_width_dim}  ,
     #1~padding-bottom-width/.store =  {l_phd_#2_padding_bottom_width_dim} ,
     #1~padding-left-width/.store   =  {l_phd_#2_padding_left_width_dim}   ,
     #1~margin-top-width/.store     =  {l_phd_#2_margin_top_width_dim}    ,
     #1~margin-right-width/.store   =  {l_phd_#2_margin_right_width_dim}  ,
     #1~margin-bottom-width/.store  =  {l_phd_#2_margin_bottom_width_dim} ,
     #1~margin-left-width/.store    =  {l_phd_#2_margin_left_width_dim}   ,
   }
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \l_phd_make_new_numbering_keys:n #1
  {
\cxset{
     #1~number~prefix/.store       = l_phd_#1_number_prefix_tl,
     #1~number~suffix/.store       = l_phd_#1_number_suffix_tl,

     #1~number~after/.store        = l_phd_#1_number_after_tl,
     #1~numbering/.is~choice,
     #1~numbering/roman/.code          =
       \cs_gset:cpn {the#1}
         {
           \cs:w l_phd_#1_number_prefix_tl \cs_end:
             \@roman\cs:w c@#1\cs_end:\relax
           \cs:w l_phd_#1_number_suffix_tl \cs_end:
         },
     #1~numbering/Roman/.code          =
      \cs_gset:cpn {the#1}
        {
          \cs:w l_phd_#1_number_prefix_tl \cs_end:
          \expandafter\@Roman{\cs:w c@#1\cs_end:\relax}
          \cs:w l_phd_#1_number_suffix_tl \cs_end:
        },
    #1~numbering/(roman)/.code          =
    \cs_gset:cpn {the#1}
       {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
         (\@roman\cs:w c@#1\cs_end:\relax)
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
       },
    #1~numbering/(Roman)/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        (\@Roman \cs:w c@#1\cs_end:\relax)
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/arabic/.code           =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \@arabic\cs:w c@#1\cs_end: \relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/numeric/.code          =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \@arabic\cs:w c@#1\cs_end:\relax
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/none/.code             =
    \cs_gset:cpn {the#1} {},
   #1~numbering/alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \exp_after:wN \alphalph {\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/Alpha/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
          \exp_after:wN \AlphAlph{\cs:w c@#1\cs_end:\relax}
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/words/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
       \words@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/Words/.code            =
    \cs_gset:cpn {the#1}
      {
        \cs:w l_phd_#1_number_prefix_tl \cs_end:
        \Words@cx{\@arabic\cs:w c@#1\cs_end:\relax }
        \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering/WORDS/.code            =
    \cs_gset:cpn {the#1}
      {
       \cs:w l_phd_#1_number_prefix_tl \cs_end:
       \WORDS@cx{\@arabic\cs:w c@#1\cs_end:\relax}
       \cs:w l_phd_#1_number_suffix_tl \cs_end:
      },
   #1~numbering~custom/.code           =
    \cs_gset:cpn {the#1} {##1},
  }
 }
\ExplSyntaxOff
\ExplSyntaxOn

\clist_map_inline:Nn \phd_book_divisions_clist
  {
    \l_phd_make_new_heading_keys:n{#1}{#1}
    \l_phd_make_new_numbering_keys:n{#1}
  }

\clist_map_inline:Nn \phd_book_divisions_clist
  {  \wlog{#1, }
    \l_phd_make_new_heading_keys:n {#1~title}{#1_title}
    \l_phd_make_new_heading_keys:n {#1~title~before}{#1_title_before}
    \l_phd_make_new_heading_keys:n {#1~number}{#1_number}
    \l_phd_make_new_heading_keys:n {#1~number~before}{#1_number_before}
    \l_phd_make_new_heading_keys:n {#1~label}{#1_label}
    \l_phd_make_new_heading_keys:n {#1~label~before}{#1_label_before}
    \l_phd_make_new_heading_keys:n {#1~before}{#1_before}
    \l_phd_make_new_heading_keys:n {#1~after}{#1_after}
  }

\ExplSyntaxOff

\ExplSyntaxOn
\cs_new:Npn \l_phd_set_headings_key_defaults:n #1
  {
    \cxset
      {
       % #1~name                   = Chapter,
      %  #1~numbering              = arabic,
        #1~align                  = Centering,
        #1~format                 = block,
        #1~font-size              = HUGE,
        #1~font-weight            = bold,
        #1~font-family            = sffamily,
        #1~font-shape             = upshape,
        #1~case                   = upper,
        #1~color                  = black,
        #1~background-color       = bgsexy,
        #1~frame-color            = bgsexy,
        #1~indent                 = 0pt,
        #1~beforeskip             = 10pt,
        #1~afterskip              = -3ex,
        #1~afterindent            = off,
        #1~arc                    = 0pt,
        #1~afterindent            = off,
        #1~grow~left              = 0mm,
        #1~grow~right             = 0mm,
        #1~rounded~corners        = northeast,
        #1~shadow                 = drop~shadow,
        #1~borderline~top          = 1pt,
        #1~borderline~right        = 1pt,
        #1~borderline~bottom       = 1pt,
        #1~borderline~left         = 1pt,
        #1~borderline~top-color    = black,
        #1~borderline~right-color  = black,
        #1~borderline~bottom-color = black,
        #1~borderline~left-color   = black,
        #1~border-left-width      = 1pt,
        #1~border-right-width     = 1pt,
        #1~border-top-width       = 1pt,
        #1~border-bottom-width    = 1pt,

        #1~padding-left-width     = 1pt,
        #1~padding-right-width    = 1pt,
        #1~padding-top-width      = 1pt,
        #1~padding-bottom-width   = 1pt,
     }
  }
\clist_map_inline:Nn \phd_book_divisions_clist
  { \wlog{set defaults ... #1 ...,}
    \l_phd_set_headings_key_defaults:n {#1}
    \l_phd_set_headings_key_defaults:n {#1~title}
    \l_phd_set_headings_key_defaults:n {#1~title~before}
    \l_phd_set_headings_key_defaults:n {#1~label}
    \l_phd_set_headings_key_defaults:n {#1~label~before}
    \l_phd_set_headings_key_defaults:n {#1~number}
    \l_phd_set_headings_key_defaults:n {#1~number~before}
    \l_phd_set_headings_key_defaults:n {#1~before}
    \l_phd_set_headings_key_defaults:n {#1~after}
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cxset
  {
    section~spaceout/.is~choice,
    section~spaceout/soul/.code            = \@sectionspaceouttrue,
    section~spaceout/none/.code            = \@sectionspaceoutfalse,
 }
\ExplSyntaxOff

\ExplSyntaxOn
\cs_new:Npn \set_font_aux:n #1
 {
   \cs_if_exist_use:c { #1_fontfamily_tl }
   \cs_if_exist_use:c { #1_fontweight_tl }
   \cs_if_exist_use:c { #1_fontshape_tl  }
   \cs_if_exist_use:c { #1_fontsize_tl   }
 }
\cs_new:Npn \set_borders_aux:nn #1 #2
 {
   \dim_if_exist:cTF{l_phd_#1_border_#2_width_dim } {8pt}{2pt}
  }

\cs_new:Npn \set_color_aux:nn #1 #2
 {
   \cs:w l_phd_#1_#2_color_tl \cs_end:
 }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \set_borderline_aux:nn #1 #2
{
   \tcbset{borderline~style/.style =
   {
     borderline~west = {\cs:w l_phd_#1_borderline_left_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {left}-0pt }
                       {
                        \cs:w l_phd_#1_borderline_left_color_tl \cs_end: ,
                         solid,
                       },
     borderline~east = {\cs:w l_phd_#1_borderline_right_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {right}-0pt }
                       {
                         \cs:w l_phd_#1_borderline_right_color_tl \cs_end:,
                         solid
                       },
     borderline~north = {\cs:w l_phd_#1_borderline_top_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {top}-0pt }
                       { \cs:w l_phd_#1_borderline_top_color_tl \cs_end:,
                        dashed},
     borderline~south = {\cs:w l_phd_#1_borderline_bottom_tl \cs_end:}
                       {-\set_borders_aux:nn {#1} {bottom}-0pt }
                       {
                         \cs:w l_phd_#1_borderline_bottom_color_tl \cs_end:,
                         dashed
                       },
    }
  }
}
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_inmargin:nnn #1#2#3
  {
     \tcbdocmarginnote
     {

       \hbox{Section~\@svsec}
       #3
     }
  }
\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \format_hang:nn #1#2#3
  {
    \phd_hang_from:nn
        {
         \set_font_aux:n {l_phd_#1}
         {\hskip 0pt %indent
           \cs:w the#1 \cs_end:
           \hskip1em
         }
        }
        {
          \set_font_aux:n {l_phd_#1}
          \cs:w
          l_phd_#1_color_tl
          \cs_end:
          #3
        }
    \interlinepenalty\@M
    \@@par
    \par \nobreak
    \skip_vertical:c {l_phd_#1_afterskip_tl}
    \@afterheading
    \tex_ignorespaces:D
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_hang_inmargin:nn #1#2
  {
    \bgroup
    \parindent0pt
    \setbox\@tempboxb\hbox
     {
       \set_font_aux:n {l_phd_#1}
       \expandafter\@arabic\cs:w c@#1 \cs_end:
     }
     \makebox[0pt]{
          \makebox[-\wd\@tempboxb][r]{%
         \set_font_aux:n {l_phd_#1}
         {
           \tcbox[nobeforeafter,box~align=center,
                  colback=bgsexy]
                  {
                    \cs:w the#1 \cs_end:
                  }
         }
        }
        }
     \begin{tcolorbox}[size=minimal,nobeforeafter,box~align=center]
          \set_font_aux:n {l_phd_#1}
          \cs:w
          l_phd_#1_color_tl
          \cs_end:
          #2
    \end{tcolorbox}
    \egroup
    \interlinepenalty\@M
    \@@par
    \par \nobreak
    \skip_vertical:c {l_phd_#1_afterskip_tl}
    \@afterheading
  }
\ExplSyntaxOff

\ExplSyntaxOn
\bool_new:N \combo_if_bool \bool_gset_true:N \combo_if_bool
\cs_set:Npn \format_block:nnnn #1#2#3#4
  {
    \bgroup
    %\leftskip-1.25in
    \set_borderline_aux:nn {#1}{}
    \begin{tcolorbox}[enhanced,
      width       = \textwidth-4pt, %\pdfpagewidth-4cm,
      arc         = 10mm,
      auto~outer~arc,
      \cs_if_exist_use:cTF {l_phd_#1_shadow_tl}{}{},
        colback           = \set_color_aux:nn {#1}{background},
        colframe          = \set_color_aux:nn {#1}{frame},
        toprule           = \set_borders_aux:nn {#1} {top},
        rightrule         = \set_borders_aux:nn {#1} {right},
        bottomrule        = \set_borders_aux:nn {#1} {bottom},
        leftrule          = \set_borders_aux:nn {#1} {left},
        %borderline~style,
        rounded~corners=all,
        drop~lifted~shadow=black,
     ]
     \bool_if:NTF \combo_if_bool
     {
       \phd_float_box:nnn {chapter_number} {}{
         \tcbox{\cs:w #1name\cs_end:\space
                \cs:w the#1\cs_end:}
           }
    }
    {
     \phd_float_box:nnn {#1}{}
       {
         \tcbox{\@svsec}

       }
    }
   \phd_float_box:nnn {#1_title_before}{}{}
   \phd_float_box:nnn {#1_title}{}{#4}
   \par
   \end{tcolorbox}
 \egroup
 \par\nobreak\nointerlineskip
}
\cs_set:Npn \phd_float_box:nnn #1 #2 #3
{\set_borderline_aux:nn {#1}{}
  \begin{tcolorbox}
    [
      size=minimal,no~shadow,
      colback  = \cs:w l_phd_#1_background_color_tl \cs_end:,
      colframe = \cs:w l_phd_#1_frame_color_tl \cs_end:,
      toprule  = .1pt,
      borderline~style,
     ]
    \cs:w l_phd_#1_align_tl \cs_end:
    \begin{tcolorbox}
      [
        %#1~outer,
        size=minimal,
        no~shadow,
        colback = \cs:w l_phd_#1_background_color_tl \cs_end:,
        colframe= \cs:w l_phd_#1_frame_color_tl \cs_end:,,
        boxsep=10pt,
        %drop~shadow,
        width=0.7\textwidth,
        borderline~style,
       % halign = ,
       ]
       {   \language-1\relax

      \set_font_aux:n {l_phd_#1}
      \cs:w  l_phd_#1_color_tl       \cs_end:
      \cs:w  l_phd_#1_align_tl  \cs_end:
       {#3}\relax %

      }
  \end{tcolorbox}
   \par
  \end{tcolorbox}
}

\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_display:nnnn #1 #2 #3 #4
{
  \cxset{#1~title~margin-top-width=30pt}
  \format_block:nnnn {#1}{#2}{#3}{#4}
}
 \ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \format_inline:nnn #1 #2 #3
  {
   {\bfseries\normalfont
    \theparagraph #3}
   }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_new:Npn \format_part_traditional:nn #1 #2 #3
  {\par\leavevmode
   \group_begin:
    \centering
     \interlinepenalty \@M
     \normalfont
     \cs:w l_phd_#1_number_tl\cs_end:
     \set_font_aux:n {l_phd_#1_number}
     \ifnum \c@secnumdepth >-2\relax
       \partname\nobreakspace\thepart
       \par
       \vskip 20\p@
     \fi
     \group_begin:
       %\set_color:nn {#1}{color}
       \set_font_aux:n {l_phd_#1 }
          #3
     \group_end:
     \par
   \group_end:
  }
\ExplSyntaxOff
\ExplSyntaxOn
\DeclareDocumentCommand \start_section:nnnnnnnnn {m m m m m m s o m}
  {
    \if@noskipsec \leavevmode \fi
    \par
    \l_tmpa_skip #4\relax
    \@afterindenttrue
    \if_dim:w \l_tmpa_skip <\z@
      \skip_gset:Nn\l_tmpa_skip {-\l_tmpa_skip}
      \@afterindentfalse
    \fi:
    \if@nobreak
      \everypar{\tikzi[start\\sect]}
    \else
      \addpenalty \@secpenalty
      \addvspace\l_tmpa_skip
    \fi
    \IfBooleanTF {#7}
      {\@ssect {#3} {#4} {#5} {#6} {#9} }
      {
        \IfValueTF {#8} {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} }
                        {\@sect:  {#1} {#2} {#3} {#4} {#5} {#6} [{#8}] {#9} } %sends TF we get it later
      }
  }
\@ltxcompatfalse
\if@ltxcompat
  \else
  \cs_gset_eq:NN \@startsection \start_section:nnnnnnnnn
\fi

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \@sect: #1 #2 #3 #4 #5 #6 [#7] #8
  {

    \int_compare:nTF {#2>\c@secnumdepth}
      {
         \let\@svsec\@empty
      }
      {
        \refstepcounter{#1}
        \protected@edef\@svsec
          {
            \@seccntformat{#1}\relax
          }
        % add short title or long title
        \IfValueTF{#7}
          {
             \cs:w #1mark\cs_end: {#7}
             \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}{#7}}
          }
          {
             \cs:w #1mark\cs_end: {#8}
              \addcontentsline{toc}{#1}{
                \protect\numberline{\csname the#1\endcsname}{#8}}
          }
      }

   \@tempskipa #5\relax
   \gdef\@svsechd{
   %\@seccntformat{#1}#6{\hskip #3\relax #8}
   #8
   }%

    \str_case_x:nnTF {\cs:w l_phd_#1_format_tl \cs_end:}
      {
          { display } {\format_display:nnnn { #1 } { #3 } {#6} { #8 }
                        \xsect:n {#5}   }
          { block   } { \format_block:nnnn  {#1 } { #3 } {#6} { {#8}       }
                        \xsect:n {#5}
                      }
          { plain   } { \format_hang:nn    {#1} { #3 } { #8 } }
          { hang    } {

                        \format_hang:nn    { #1 } { #3 } {{#8}
                         %\xsect:n {#5}
                          }
                      }
          { hanginmargin } {\format_hang_inmargin:nn {#1} {#8}      }
          { leftmargin   } {\format_hang_inmargin:nn {#1} {#8}      }
          { inline       } {  \xsect:n {-3.5ex} }%#5
          { inmargin     } {\format_inmargin:nnn {#1} {#3} {#6#8} }
          { traditional  } {\format_part_traditional:nn {#1}{#3}{#8}}
      }
      {
      %{\if@debug~\tiny\csname#1format@cx\endcsname \fi }
      } %true code
      {
        {
        %\if@debug~\tiny\csname#1format@cx\endcsname\fi
        }
        \phd_hang_from:nn{#6\relax\@svsec}%
        \interlinepenalty\@M {#6#8}\par\xsect:n{#5}
      } %false code
  %
  }
\ExplSyntaxOff
\ExplSyntaxOn
\cs_set:Npn \@ssect #1 #2 #3 #4 #5 {%
  \@tempskipa #3\relax
  \ifdim \@tempskipa>\z@
  \begingroup
    #4{
    \phd_hang_from:nn{\hskip #1}%
    \interlinepenalty \@M (#5)\@@par}%
    \endgroup
  \else
  \def\@svsechd{#4{\hskip #1\relax #5}}%
  \fi
  \xsect:n{#3} %ONLY NEEDED FOR HANG PARA
}
\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \xsect:n #1
  {
  \l_tmpa_skip #1\relax
  \if_dim:w \l_tmpa_skip>0pt %WATCH better boolean
    \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading
   \else:
    \@nobreakfalse
    \global\@noskipsectrue
    \tex_everypar:D
      {\if@noskipsec
          \global\@noskipsecfalse%resets switch
          {\setbox\z@\lastbox}
          \tex_clubpenalty:D\@M
          \group_begin:
            \parindent0pt\tcbox[size=minimal,
                    nobeforeafter,
                    box~align=base]{\bfseries \@svsechd }%}
          \group_end:
          \tex_unskip:D
          \l_tmpa_skip #1\relax
          \hskip -\l_tmpa_skip
        \else
          \tex_clubpenalty:D \@clubpenalty
          \tex_everypar:D {\tikzi[every]}
        \fi
      }
  \fi:
  \tex_ignorespaces:D
  }

\cs_set:Npn \after_block:n #1
 {
   \par \nobreak
    \vskip\l_tmpa_skip
    \@afterheading
 }

\ExplSyntaxOff
 \def\@afterheading{%
 \@nobreaktrue
 \everypar{%
   \if@nobreak
     \@nobreakfalse
     \clubpenalty \@M
     \if@afterindent
     \else
      {\setbox\z@\lastbox}%
     %\tikzi[everypar]
     \fi
 \else
 \clubpenalty \@clubpenalty
 \everypar{
   %\tikzi[cleared]
 }%
 \fi}
 }
\ExplSyntaxOn
 \cs_gset:Npn \@seccntformat #1
 {
  \@ifundefined{#1@cntformat}%
  {\csname the#1\endcsname\section_number_after_tl}% default
  {\csname #1_cntformat\endcsname}% individual control
 }
\tl_set:Nn  \section_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subsubsection_number_after_tl{\quad}%default value only space
\tl_set:Nn  \l_phd_paragraph_number_after_tl{\quad}%default value only space
\tl_set:Nn  \subparagraph_number_after_tl{\quad}%default value only space
\cs_set:Npn \section_cntformat{\thesection\section_number_after_tl}
\cs_set:Npn \subsection_cntformat{\thesubsection\subsection_number_after_tl}
\cs_set:Npn \subsubsection_cntformat{\thesubsubsection\subsubsection_number_after_tl}
\cs_set:Npn \paragraph_cntformat {\theparagraph\l_phd_paragraph_number_after_tl }
\cs_set:Npn \subparagraph_cntformat {\thesubparagraph\subparagraph_number_after_tl }
\ExplSyntaxOff
\ExplSyntaxOn
 \renewcommand\part {%
   \newpage\null
   \thispagestyle{empty}
    \start_section:nnnnnnnnn{part}%
      {-1}  %level check this conflicts with source2e
      {\l_phd_part_indent_tl} %indent#2

      {\l_phd_part_before_skip_tl}%before skip#3

      {\l_phd_part_afterskip_tl}% after skip#4

      {
          %\expandafter\setfontparam@cx\l_phd_chapter_align_tl;%
          \l_phd_part_color_tl %5
      }
 }%

 \renewcommand\chapter {%
   \newpage\null
   \thispagestyle{empty}
    \start_section:nnnnnnnnn{chapter}%
      {0}  %level check this conflicts with source2e

      {\l_phd_chapter_indent_tl} %indent#2

      {\l_phd_chapter_before_skip_tl}%before skip#3

      {\l_phd_chapter_afterskip_tl}% after skip#4

      {
          %\expandafter\setfontparam@cx\l_phd_chapter_align_tl;%
          %\color{\l_phd_chapter_color_tl}%5
      }
 }%


\if@ltxcompat
\else
  \renewcommand\section{%
    \@startsection{section}%
      {1}%level check this conflicts with source2e

      {\l_phd_section_indent_tl}%indent#2

      {\l_phd_section_before_skip_tl}%before skip#3

      {\l_phd_section_afterskip_tl}% after skip#4

      {
        \set_font_aux:n {l_phd_section}
          \l_phd_section_color_tl %5
      }
 }%
\fi
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\else
 \renewcommand\subsection
    {
      \@startsection{subsection}
        {1}
        {\l_phd_subsection_indent_tl}%indent
        {\l_phd_subsection_before_skip_tl}%before skip#3
        {\l_phd_subsection_afterskip_tl}% after skip#4

        {
        \set_font_aux:n {l_phd_subsection}
         % \expandafter\setfontparam@cx\l_phd_subsection_align_tl;%
         \l_phd_subsection_color_tl  %5
        }
   }
\fi
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\else
\renewcommand{\subsubsection}
{
  \@startsection{subsubsection}%
    {3}%level
    {\l_phd_subsubsection_indent_tl}%indent
    {\l_phd_subsubsection_before_skip_tl}
    {\l_phd_subsubsection_afterskip_tl}
    {
      \set_font_aux:n {l_phd_subsubsection}
%%    {\l_phd_subsubsection_fontweight_tl }
%%    {\l_phd_subsubsection_fontfamily_tl}
%%    {\l_phd_subsubsection_fontsize_tl}
%%    {\l_phd_subsubsection_fontshape_tl}
%%      \expandafter\setfontparam@cx
      \l_phd_subsubsection_color_tl
    }
}
\fi
\ExplSyntaxOff

\ExplSyntaxOn
  \renewcommand\paragraph{
     \@startsection{paragraph}
     {4}%level
     {\l_phd_paragraph_indent_tl}%indent
     {\l_phd_paragraph_before_skip_tl}%
     {\l_phd_paragraph_afterskip_tl}%
     {
      \set_font_aux:n {l_phd_paragraph}
      \l_phd_paragraph_color_tl
     }%
   }
\ExplSyntaxOff
\ExplSyntaxOn
\if@ltxcompat
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{0pt}%
                                       {2ex}%
                                       {-1em}%
                                      {\normalfont\normalsize\bfseries}}
\else
\renewcommand\subparagraph
      {
         \@startsection{subparagraph}
         {5}%level
         {\l_phd_subparagraph_indent_tl}%indent
         {\l_phd_subparagraph_before_skip_tl}
         {\l_phd_subparagraph_afterskip_tl}
         {
           \set_font_aux:n {l_phd_subparagraph}
           \expandafter\setfontparam@cx
            \l_phd_subparagraph_align_tl;
            \l_phd_subparagraph_color_tl
         }
       }

\fi
\ExplSyntaxOff

\cxset { section name              = Section,
    section format                 = leftmargin,
    section align                  = Centering,
    section title align            = Centering, %checked
    section font-size              = Large,
    section font-weight            = bfseries,
    section font-family            = serif,
    section font-shape             = upshape,
    section number font-size       = Large,
    section number font-weight     = bfseries,
    section number font-family     = serif,
    section number font-shape      = upshape,
    section title font-size        = Large,
    section title font-weight      = bfseries,
    section title font-family      = serif,
    section title font-shape       = upshape,
    section color                  = black,
    section number prefix          = \thechapter.,
    section number suffix          =,
    section numbering              = arabic,
    section indent                 = 0pt,
    section beforeskip             = -3ex,
    section afterskip              = 1.5ex \@plus .1ex,
    section afterindent            = off,
    section number after           = \quad,
    section arc                    = 3pt,
    section background-color       = white,
    section afterindent            = off,
    section grow left              = 0mm,
    section grow right             = 0mm,
    section rounded corners        = northeast,
    section border-left-width      = 0pt,
    section border-right-width     = 0pt,
    section border-top-width       = 2pt,
    section border-bottom-width    = 2pt,
    section padding-left-width     = 0pt,
    section padding-right-width    = 10pt,
    section padding-top-width      = 2pt,
    section padding-bottom-width   = 2pt,
    section title margin-top-width       = 2pt,
    section title color            = spot,
    section shadow                 = no shadow,
  }
\cxset
  {
    subsection name                   = Subsection,
    subsection format                 = hang,
    subsection font-size              = large,
    subsection font-weight            = bfseries,
    subsection font-family            = rmfamily,
    subsection font-shape             = upshape,
    subsection number font-size       = large,
    subsection number font-weight     = bfseries,
    subsection number font-family     = rmfamily,
    subsection number font-shape      = upshape,
    subsection title font-size        = Large,
    subsection title font-weight      = bfseries,
    subsection title font-family      = sffamily,
    subsection title font-shape       = upshape,
    subsection title color            = spot,
    subsection color                  = bgsexy,
    subsection numbering              = arabic,
    subsection align                  = Centering, %checked
    subsection title align            = Centering, %checked
    subsection beforeskip             = -3.25ex\@plus -1ex \@minus -.2ex,
    subsection afterskip              = 1.5ex \@plus .2ex,
    subsection number prefix          = \thesection.,
    subsection indent                 = 0pt,
    subsection number after           = 0pt,
    subsection background-color       = white,
    subsection border-left-width      = 0pt,
    subsection border-right-width     = 0pt,
    subsection border-top-width       = 5pt,
    subsection border-bottom-width    = 5pt,
    subsection padding-left-width     = 0pt,
    subsection padding-right-width    = 0pt,
    subsection padding-top-width      = 20pt,
    subsection padding-bottom-width   = 20pt,
    subsection shadow                 = drop shadow,
  }
\cxset
  {
    subsubsection name                    = Subsubsection,
    subsubsection format                  = hang,
    subsubsection background-color        = white!30, %checked
    subsubsection font-family             = rmfamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection font-family             = sffamily,
    subsubsection font-size               = large,
    subsubsection font-weight             = bfseries,
    subsubsection font-family             = tiresias,
    subsubsection font-shape              = upshape,
    subsubsection color                   = bgsexy,
    subsubsection number prefix           = \thesubsection,
    subsubsection number suffix           = ,
    subsubsection numbering               = arabic,
    subsubsection indent                  = 0pt,
    subsubsection beforeskip              = -3.25ex\@plus -1ex \@minus -.2ex,
    subsubsection afterskip               = 1.5ex \@plus .2ex,
    subsubsection align                   = center,
    subsubsection title align             = center,
    subsubsection number after     =,
    subsubsection border-left-width       = 0pt,
    subsubsection border-right-width      = 0pt,
    subsubsection border-top-width        = 2pt,
    subsubsection border-bottom-width     = 0pt,
    subsubsection padding-left-width      = 0pt,
    subsubsection padding-right-width     = 0pt,
    subsubsection padding-top-width       = 20pt,
    subsubsection padding-bottom-width    = 20pt,
    subsubsection shadow                  = no shadow,
    subsubsection title font-size         = large,
    subsubsection title font-weight       = bfseries,
    subsubsection title font-family       = serif,
    subsubsection title font-shape        = upshape,
    subsubsection title color             = spot,
  }
\cxset
  {
    paragraph name                = paragraph,
    paragraph format              = inline,
    paragraph name                = paragraph,
    paragraph font-size           = large,
    paragraph font-weight         = bfseries,
    paragraph font-family         = rmfamily,
    paragraph font-shape          = upshape,
    paragraph numbering           = alpha,
    paragraph align               = flushleft,
    paragraph beforeskip          = 3.25ex plus1ex minus.2ex,
    paragraph afterskip           = -1em,
    paragraph indent              = 0pt,
    paragraph number after        = \quad,
    paragraph color               = bgsexy,
    paragraph background-color    = white,
    paragraph shadow              = no shadow,
  }
\cxset
  {
    subparagraph name             = subparagraph,
    subparagraph format           = inline,
    subparagraph name             = subparagraph,
    subparagraph font-size        = large,
    subparagraph font-weight      = bfseries,
    subparagraph font-family      = rmfamily,
    subparagraph font-shape       = upshape,
    subparagraph color            = bgsexy,
    subparagraph background-color = bgsexy,
    subparagraph numbering        = none,
    subparagraph align            = flushleft,
    subparagraph beforeskip       = 3.25ex plus1ex minus .2ex,
    subparagraph afterskip        = -1em,
    subparagraph indent           = 0pt,
    subparagraph number after     = ,
    subparagraph shadow           = off,
  }
\cxset{chapter title style/.style= {
       chapter title align = left,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
\cxset{section title style/.style= {
       section title align = Centering,}
 }
 \cxset{subsection title style/.style= {
       subsection title align = Centering,}
 }
 \cxset{subsubsection title style/.style=
   {
        subsubsection align       = #1,
        subsubsection title align = #1,
   }
 }
 \cxset{subsubsection title style= raggedright}
\ExplSyntaxOn
\cs_set:Npn \testsections
  {
    \section{Sections}
    \lorem\par
    \subsection{Subsections}
    \lorem\par
    \subsubsection{Subsubsections}
    \lorem\par
    \paragraph {Paragraph}
  }
\cs_set_eq:NN \TestSections\testsections
\ExplSyntaxOff
\endinput
%%
%% End of file `phd-lowersections.sty'.
